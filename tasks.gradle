import groovy.json.JsonSlurper

task setMinorVersion {
    doLast {
        ["git", "checkout", ciBranchName].execute().text

        def sourceFile = new File('gradle.properties')
        def versionField = (sourceFile.text =~ /^projectVersion.+\b/)[0]
        def rawVersionField = versionField.split('\\.')

        if (minorVersion.size() != 0) {
            if (rawVersionField.size() == 2) {
                versionField = "${versionField}.${minorVersion}"
            } else {
                versionField = "${rawVersionField[0]}.${rawVersionField[1]}.${minorVersion}"
            }
            sourceFile.write(sourceFile.text.replaceAll(/^projectVersion.+\b/, versionField))
        }

        ["git", "add", "gradle.properties"].execute().text
        ["git", "commit", "-m","Set minor version [skip ci]"].execute().text
        ["git", "push", "http://${ciCredentials}@${ciProjectPath}", "HEAD:" + ciBranchName].execute().text
    }
}

/*
task releaseTrain {
    doLast {
        def versions = new JsonSlurper().parseText(new File("release-train.json").text)
        def currentBranch = ciBuildRefName

        if (currentBranch in versions) {
            def nextBranch = versions.getAt(versions.indexOf(currentBranch) + 1)

            ["git", "checkout", currentBranch].execute().text
            ["git", "checkout", nextBranch].execute().text

            String mergeAttempt = ["git", "merge", currentBranch].execute().text

            if (mergeAttempt.contains("merge failed")) {
                throw new Error("Merge conflict")
            }

            ["git", "push", "http://${ciCredentials}@${ciProjectPath}", "HEAD:" + nextBranch].execute().text
        }
    }
}

task releaseDocker(dependsOn: build) {
    doLast {
        def registryUrl = 'docker-registry.cardpay-test.com'
        def imageName = 'log-service-local'

        copy {
            from 'src/main/resources/docker/Dockerfile'
            from 'build/libs/log-service.war'
            into 'build/docker'
        }
        exec {
            workingDir 'build/docker'
            commandLine 'docker', 'build', '-t', "${registryUrl}/cardpay/${imageName}:${getMajorVersion()}", '.'
        }
        exec { commandLine 'docker', 'login', registryUrl, "-u=${dockerUsername}", "-p=${dockerPassword}" }
        exec { commandLine 'docker', 'push', "${registryUrl}/cardpay/${imageName}:${getMajorVersion()}" }
        exec { commandLine 'docker', 'rmi', "${registryUrl}/cardpay/${imageName}:${getMajorVersion()}" }
    }
}

def getMajorVersion() {
    (projectVersion =~ /^.{3}/)[0]
}
*/
